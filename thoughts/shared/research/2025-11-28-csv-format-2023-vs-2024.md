---
date: 2025-11-28T14:45:39+01:00
researcher: nils
git_commit: a81afa09e2a48eedefdf06dd57d663a8535baa8a
branch: master
repository: tastyworks-tax-calculator
topic: "Tastyworks CSV Format Changes Between 2023 and 2024"
tags: [research, codebase, csv-parsing, transaction-processing, tastyworks]
status: complete
last_updated: 2025-11-28
last_updated_by: nils
---

# Research: Tastyworks CSV Format Changes Between 2023 and 2024

**Date**: 2025-11-28T14:45:39+01:00
**Researcher**: nils
**Git Commit**: a81afa09e2a48eedefdf06dd57d663a8535baa8a
**Branch**: master
**Repository**: tastyworks-tax-calculator

## Research Question

How does the application handle the differences between 2023 and 2024 Tastyworks transaction CSV formats? The 2023 format has 18 columns while the 2024 format has 21 columns, with the addition of "Sub Type", "Total", and "Currency" columns.

## Summary

The current implementation of `TransactionCsvReader` is hardcoded to support **only the 2024 CSV format** (21 columns). The code uses fixed column indices via extension functions and has no format detection logic. All test CSV files use the 2024 format. The application **cannot currently handle 2023 format files** and would fail with `ArrayIndexOutOfBoundsException` if processing 2023 format CSVs.

### Format Differences

**2023 Format (18 columns):**
```
Date,Type,Action,Symbol,Instrument Type,Description,Value,Quantity,Average Price,Commissions,Fees,Multiplier,Root Symbol,Underlying Symbol,Expiration Date,Strike Price,Call or Put,Order #
```

**2024 Format (21 columns):**
```
Date,Type,Sub Type,Action,Symbol,Instrument Type,Description,Value,Quantity,Average Price,Commissions,Fees,Multiplier,Root Symbol,Underlying Symbol,Expiration Date,Strike Price,Call or Put,Order #,Total,Currency
```

**Key Differences:**
- **Column 2**: New "Sub Type" column inserted after "Type" (shifts all subsequent columns)
- **Column 19**: New "Total" column added
- **Column 20**: New "Currency" column added

## Detailed Findings

### Current CSV Parsing Implementation

#### Extension Functions (TransactionCsvReader.kt:204-222)

The implementation uses extension functions on `Array<String>` that hardcode column indices for the **2024 format**:

```kotlin
fun Array<String>.date() = this[0]
fun Array<String>.type() = this[1]
fun Array<String>.subType() = this[2]              // 2024-only column
fun Array<String>.action() = this[3]               // Index 2 in 2023, 3 in 2024
fun Array<String>.symbol() = this[4]               // Index 3 in 2023, 4 in 2024
fun Array<String>.instrumentType() = this[5]       // Index 4 in 2023, 5 in 2024
fun Array<String>.description() = this[6]          // Index 5 in 2023, 6 in 2024
fun Array<String>.value() = this[7].replace(",", "").toFloat().toMonetaryAmountUsd()
fun Array<String>.quantity() = this[8].toInt()
fun Array<String>.averagePrice() = this[9].toFloat().toMonetaryAmountUsd()
fun Array<String>.commissions() = this[10].toFloat().toMonetaryAmountUsd()
fun Array<String>.fees() = this[11].toFloat().toMonetaryAmountUsd()
fun Array<String>.multiplier() = this[12]
fun Array<String>.rootSymbol() = this[13]
fun Array<String>.underlyingSymbol() = this[14]
fun Array<String>.expirationDate() = this[15]
fun Array<String>.strikePrice() = this[16].toFloat().toMonetaryAmountUsd()
fun Array<String>.callOrPut() = this[17]
fun Array<String>.orderNr() = this[18]
/*
 * Between 2023 and 2024 the csv format has change. Three columns were added.
 */
fun Array<String>.isPre2024Format() = this.size == 18
```

All column indices from index 2 onwards differ between the two formats due to the "Sub Type" column insertion.

#### Filtering Logic (TransactionCsvReader.kt:28-35)

The `read()` method filters CSV rows using hardcoded indices:

```kotlin
.filter {
    val type = it[1]        // Works for both formats (Type at index 1)
    val action = it[2]      // 2023: Action, 2024: Sub Type
    type == "Trade" ||
    (
        type.contains("Receive Deliver")
    )
}
```

**Issue**: Line 30 declares `action = it[2]` but this variable is unused in the filter. The filter only checks `type`. This creates confusion about intent but accidentally doesn't break 2023 compatibility for the filter itself.

#### Transaction Type Detection

All transaction type detection methods use the extension functions, which are hardcoded for 2024 format:

**isOptionTrade() (TransactionCsvReader.kt:81-86):**
```kotlin
private fun isOptionTrade(columns: Array<String>): Boolean {
    val type = columns.type()                    // Index 1 - OK for both
    val instrumentType = columns.instrumentType() // Index 5 - WRONG for 2023 (should be 4)
    val isOptionTrade = type == "Trade" && instrumentType == "Equity Option"
    log.debug("isOptionTrade type='{}', instrumentType='{}', isOptionTrade='{}'", type, instrumentType, isOptionTrade)
    return isOptionTrade
}
```

**isReverseSplit() (TransactionCsvReader.kt:89-95):**
```kotlin
private fun isReverseSplit(columns: Array<String>): Boolean {
    val type = columns.type()
    val instrumentType = columns.instrumentType()
    val subType = columns.subType()  // 2024-only column - would fail for 2023
    val isReverseSplit = type == "Receive Deliver" && subType == "Reverse Split" && instrumentType == "Equity"
    log.debug("isReverseSplit type='{}', subType='{}', instrumentType='{}', isOptionTrade='{}'", type, subType, instrumentType, isReverseSplit)
    return isReverseSplit
}
```

The `subType()` accessor is used in multiple places:
- `isReverseSplit()` at line 92
- `optionAssignment()` at line 64
- `stockTrade()` at line 134

### Transaction Object Creation

All transaction creation methods use the extension functions with 2024 indices:

**optionTrade() (TransactionCsvReader.kt:157-174):**
```kotlin
private fun optionTrade(columns: Array<String>) = OptionTrade(
    date = parseDate(columns.date()),
    action = Action.valueOf(columns.action()),    // Index 3 - wrong for 2023
    symbol = columns.rootSymbol(),
    instrumentType = columns.instrumentType(),     // Index 5 - wrong for 2023
    description = columns.description(),           // Index 6 - wrong for 2023
    value = columns.value(),                       // Index 7 - wrong for 2023
    quantity = columns.quantity(),                 // Index 8 - wrong for 2023
    averagePrice = columns.averagePrice(),         // Index 9 - wrong for 2023
    commissions = columns.commissions(),           // Index 10 - wrong for 2023
    fees = columns.fees(),                         // Index 11 - wrong for 2023
    multiplier = columns.multiplier().toInt(),     // Index 12 - wrong for 2023
    underlyingSymbol = columns.underlyingSymbol(), // Index 14 - wrong for 2023
    expirationDate = parsLocalDate(columns.expirationDate()), // Index 15 - wrong for 2023
    strikePrice = columns.strikePrice(),           // Index 16 - wrong for 2023
    callOrPut = columns.callOrPut(),               // Index 17 - wrong for 2023
    orderNr = columns.orderNr().toInt()            // Index 18 - wrong for 2023
)
```

### Test Files

All test CSV files in `/home/nils/ws/tastyworks-tax-calculator/src/test/resources/` use the **2024 format**:

- `optionTrade.csv` - 21 columns with "Sub Type" header
- `stockTrade.csv` - 21 columns, includes "Total" and "Currency" columns in reverse split rows
- `optionRemoval.csv` - 21 columns with "Sub Type" header
- `optionAssignment.csv` - 21 columns with "Sub Type" header

**Example from stockTrade.csv (lines 3-4):**
```csv
2024-06-17T12:47:02+0200,Receive Deliver,Reverse Split,BUY_TO_OPEN,WKHS,Equity,Reverse split: Open 20.0 WKHS,"-1,100.00",20,-55.00,--,0.00,,,,,,,,"-1,100.00",USD
```

The "Reverse Split" value in column 2 (Sub Type) and "USD" in column 20 (Currency) confirm these are 2024 format files.

### No Format Detection Logic

The codebase contains **zero format detection logic**. The implementation assumes:

1. **Fixed column count**: All CSV files have exactly 21 columns
2. **Fixed column order**: Columns never change position
3. **Sub Type column exists**: Code references `columns.subType()` in multiple places
4. **No validation**: No checks for column count or format version

### What Would Happen with 2023 Format

Processing a 2023 format CSV file would result in:

1. **ArrayIndexOutOfBoundsException**: When accessing indices beyond 17
   - `columns.orderNr()` accesses index 18 (doesn't exist in 2023)
   - All extension functions from index 3+ read wrong columns

2. **Incorrect Data Parsing**: Even if the file had enough columns:
   - `columns.action()` would read "Symbol" instead of "Action"
   - `columns.symbol()` would read "Instrument Type" instead of "Symbol"
   - All subsequent fields would be shifted by one position

3. **Type Conversion Errors**:
   - String values would be parsed as numbers (e.g., "APPH" as a float)
   - Would cause `NumberFormatException`

## Code References

**Core parsing implementation:**
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:22-45` - Main read() method
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:49-58` - parseTransaction() dispatcher
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:204-222` - Extension functions with hardcoded indices

**Transaction type detection:**
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:81-86` - isOptionTrade()
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:89-95` - isReverseSplit() (uses subType)
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:101-106` - isOptionRemoval()
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:109-115` - isStockTrade()
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:73-78` - isAssignment()

**Transaction object creation:**
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:157-174` - optionTrade()
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:144-155` - optionRemoval()
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:118-142` - stockTrade() (uses subType at line 134)
- `src/main/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReader.kt:60-71` - optionAssignment() (uses subType at line 64)

**Test files (all 2024 format):**
- `src/test/resources/optionTrade.csv` - Option trade examples
- `src/test/resources/stockTrade.csv` - Stock trade and reverse split examples with Total/Currency columns
- `src/test/resources/optionRemoval.csv` - Option expiration and assignment removal examples
- `src/test/resources/optionAssignment.csv` - Assignment examples

**Test validation:**
- `src/test/kotlin/com/elchworks/tastyworkstaxcalculator/transactions/TransactionCsvReaderTest.kt:18-67` - Unit tests for CSV parsing

## Architecture Documentation

### CSV Processing Flow

1. **File Discovery** (ApplicationRunner.kt:28-50):
   - Walks transaction directory tree
   - Excludes `/snapshots/` subdirectory
   - Processes all CSV files found

2. **CSV Parsing** (TransactionCsvReader.kt:22-45):
   - Opens CSV file using OpenCSV library
   - Reads all rows into memory
   - Filters by transaction type (Trade or Receive Deliver)
   - Removes header row
   - Maps each row to Transaction object

3. **Type Detection** (TransactionCsvReader.kt:49-58):
   - Uses `when` expression to determine transaction type
   - Checks type and instrument type combinations
   - Dispatches to appropriate parsing method

4. **Transaction Creation**:
   - Creates strongly-typed Transaction objects
   - Converts strings to appropriate types (MonetaryAmount, Instant, Int, Enum)
   - Handles special cases (reverse splits, assignments)

5. **Event Publishing** (ApplicationRunner.kt:42-44):
   - Publishes `NewTransactionEvent` for each transaction
   - Events processed by Portfolio and FiscalYearManager

### Extension Function Pattern

The codebase uses Kotlin extension functions to provide named access to CSV columns:

**Pattern Benefits:**
- Named column access instead of magic numbers
- Type conversions centralized in one place
- Cleaner transaction creation code

**Pattern Drawbacks:**
- Hardcoded indices make format changes difficult
- No abstraction layer for different CSV versions
- Tightly couples parsing logic to specific format

### Data Type Conversions

**MonetaryAmount (javax.money API):**
- All currency values use `MonetaryAmount` type
- Extension function `toMonetaryAmountUsd()` converts strings
- Handles comma removal for values like "1,100.00"

**Date/Time Parsing:**
- Transaction dates: ISO 8601 format with timezone (`2022-12-21T16:31:40+0100`)
- Expiration dates: MM/DD/YY format (`12/30/22`)
- Custom DateTimeFormatter for each format

**Enum Conversions:**
- Action field converted to `Action` enum via `valueOf()`
- Would throw `IllegalArgumentException` for unknown values

## Historical Context (from thoughts/)

No existing documentation found in the thoughts/ directory about:
- CSV format changes
- Tastyworks export format evolution
- Known parsing issues or bugs
- Migration between format versions

The thoughts/ directory contains research and plans for other features (persistent state, snapshot functionality) but no information about CSV format handling.

## Related Research

No related research documents found. This is the first documentation of CSV format handling in the codebase.

## Open Questions

1. **When did Tastyworks change the format?** - The exact date or Tastyworks version when the CSV format changed from 18 to 21 columns is not documented.

2. **Are there users with 2023 format files?** - It's unclear if there are still transaction files in the old format that need to be processed.

3. **What is the Sub Type column used for?** - The "Sub Type" column appears in all 2024 files but its full purpose and all possible values are not documented. Known values include:
   - "Sell to Open"
   - "Buy to Close"
   - "Expiration"
   - "Assignment"
   - "Reverse Split"
   - "Sell to Close"
   - "Buy to Open"

4. **What is the Total column used for?** - Only visible in reverse split transactions in test files. Its purpose and when it differs from Value is unclear.

5. **What is the Currency column used for?** - Only visible in reverse split transactions showing "USD". Whether this is always USD or can vary is unclear.

6. **Should both formats be supported indefinitely?** - Decision needed on whether to:
   - Support both formats dynamically
   - Convert 2023 files to 2024 format as preprocessing step
   - Only support 2024 going forward

7. **How to detect format version?** - If supporting both, what's the best detection strategy:
   - Column count (18 vs 21)
   - Header row inspection
   - Configuration file
   - File naming convention
